local knit = require("knit")

function sel(cond, t, f)
    if cond then return t else return f end
end

local prefix = "riscv64-unknown-elf"

local conf = {
    dc = cli.dc or "ldc",
}

local machine = {
    board = "virt",
    mabi = "lp64",
    march = "rv64imac",
    arch = "riscv64",
    mcmodel = "medany",
}

if machine.mcmodel == "medany" then
    machine.cmodel = "medium"
else
    machine.cmodel = "small"
end

local tools = {
    dc = sel(conf.dc == "gdc", f"$prefix-gdc", "ldc2"),
    cc := $prefix-gcc
    as := $prefix-as
    ld := $prefix-ld
    cpp := $prefix-cpp
    objcopy := $prefix-objcopy
    objdump := $prefix-objdump
    gdb := $prefix-gdb
    qemu := qemu-system-$(machine.arch)
}

local link = "kernel/link.ld"

local flags = {
    dc = sel(
        conf.dc == "gdc",
        f"-fno-exceptions -fno-rtti -Os -nostartfiles -nostdlib -mabi=$(machine.mabi) -march=$(machine.march) -mcmodel=$(machine.mcmodel) -ffunction-sections -fdata-sections",
        f"--betterC -Oz -mtriple=$prefix -mattr=+m,+a,+c -platformlib= --code-model=$(machine.cmodel) --function-sections --data-sections"
    ),
    as := -mabi=$(machine.mabi) -march=$(machine.march) -mcmodel=$(machine.mcmodel)
    ld := -nostartfiles -T$link -mcmodel=$(machine.mcmodel) -Wl,--gc-sections
}

local meta = r{
    $ %.o: %.s
        $(tools.cc) $(flags.as) -xassembler-with-cpp $input -c -o $output
    $ %.bin: %.elf
        $(tools.objcopy) $input -O binary $output
    $ %.list: %.elf
        $(tools.objdump) -D $input > $output
}

local kern = knit.rglob("kernel", "*.d")
local lib = knit.rglob("libd", "*.d")
local dco = sel(conf.dc == "gdc", "o", "of")

local kernel = r{
    $ libd.o: $lib
        $(tools.dc) $(flags.dc) -Ikernel -Ilibd $input -c -$dco $output
    $ kernel.o: $kern libd[I]
        $(tools.dc) $(flags.dc) -Ikernel -Ilibd $input -c -$dco $output
    $ kernel.elf: kernel.o libd.o kernel/start.o $link[I]
        $(tools.cc) $(flags.as) $(flags.ld) $input -lgcc -o $output
    $ qemu:VBQ: kernel.elf
        $(tools.qemu) -machine $(machine.board) -nographic -kernel $input -bios none
    $ qemu-gdb:VBQ: kernel.elf
        $(tools.qemu) -s -S -machine $(machine.board) -nographic -kernel $input -bios none &
        $(tools.gdb) -ex "file $input" -ex "target remote localhost:1234"
}

return b{
    $ all: kernel.elf kernel.list kernel.bin

    kernel,
    meta
}
